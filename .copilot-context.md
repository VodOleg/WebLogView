# Copilot Context - WebLogView Project

**Last Updated:** December 5, 2025

## Project Overview
WebLogView is a cross-platform, web-based log viewer with real-time file monitoring that works on Windows, macOS, and Linux.

## Tech Stack
- **Backend:** Go 1.21+
  - gorilla/websocket for WebSocket communication
  - fsnotify for file system monitoring
- **Frontend:** Preact (with virtual scrolling)
- **Communication:** WebSocket for real-time updates + HTTP REST API for settings

## Project Structure
```
WebLogView/
├── cmd/
│   └── main.go                 # Application entry point
├── internal/
│   ├── config/                 # Application configuration
│   │   └── config.go
│   ├── server/                 # HTTP server and API endpoints
│   │   ├── server.go
│   │   └── static/             # Embedded frontend (generated during build)
│   ├── settings/               # Persistent settings manager
│   │   └── settings.go
│   ├── watcher/                # File system monitoring (fsnotify)
│   │   └── watcher.go
│   └── websocket/              # WebSocket hub and client management
│       ├── client.go
│       └── hub.go
├── web/                        # Frontend Preact application
│   ├── src/
│   │   ├── components/
│   │   │   ├── App.jsx             # Main app with tab management
│   │   │   ├── LogViewerTab.jsx    # Individual tab component
│   │   │   ├── LogViewer.jsx       # Virtual scrolling log display
│   │   │   ├── ControlBar.jsx      # Filters and controls
│   │   │   ├── DropZone.jsx        # File path input
│   │   │   ├── ResizablePanes.jsx  # Dual-pane layout
│   │   │   └── SettingsModal.jsx   # Settings popup
│   │   ├── hooks/
│   │   │   └── useWebSocket.js     # WebSocket connection hook
│   │   └── main.jsx
│   ├── vite.config.js
│   └── package.json
├── scripts/
│   ├── build-release.sh        # Release build script (all platforms)
│   ├── test-build.sh           # Quick test build (current platform)
│   └── README.md               # Build documentation
├── DESIGN.md                   # Detailed architecture documentation
├── README.md                   # Quick start guide
├── go.mod                      # Go module dependencies
└── Makefile                   # Build automation
```

## Key Features
- Real-time log file monitoring with fsnotify
- WebSocket-based log streaming
- Virtual scrolling for large files (react-window)
- Regex filtering (include/exclude patterns with OR/AND logic)
- Tabbed interface (Chrome-like multi-file support)
- Dual-pane layout (all lines + filtered lines)
- Resizable panes with draggable divider
- Horizontal scrolling for long log lines
- **Click-to-highlight navigation** - Click line number in filtered pane to jump to that line in all lines pane
- **ANSI color rendering** - Terminal colors displayed properly (using ansi-to-html)
- **Persistent settings** stored in `~/.weblogview/settings.json`
- Configurable initial window size (tail lines)
- Configurable ANSI rendering per pane (prettify or show raw)
- Cross-platform settings storage (Windows/macOS/Linux)
- **Production builds** - Single executable with embedded frontend (no dependencies)

## Settings System
- **Backend:** `/internal/settings/settings.go`
  - Singleton pattern with thread-safe operations
  - Persists to `~/.weblogview/settings.json`
  - Cross-platform compatible (uses `os.UserHomeDir()` and `filepath.Join()`)
- **API Endpoint:** `/api/settings`
  - `GET` - Returns current settings
  - `POST` - Updates and saves settings
- **Frontend:** Settings modal (⚙️ button in control bar)
  - Initial Window Size: 100-100,000 lines (default: 1000)
  - ANSI Rendering for Top Pane: on/off (default: on - prettified)
  - ANSI Rendering for Bottom Pane: on/off (default: on - prettified)
  - Settings saved on backend and persist across restarts
- **ANSI Rendering:** Uses `ansi-to-html` library to convert terminal color codes to HTML
  - Configurable per pane (top/bottom)
  - When enabled: Shows colored logs like in terminal
  - When disabled: Shows raw ANSI escape codes

## Default Configuration
- Port: 8080
- Host: localhost
- Auto-browser: enabled
- Initial tail lines: 1000 (configurable via settings)
- Max line buffer: 10MB
- ANSI rendering: enabled for both panes (configurable via settings)

## Recent Changes
- **Dec 5, 2025:** Updated frontend stack from Vanilla JS to Preact in DESIGN.md
- **Dec 5, 2025:** Created main entry point at `cmd/main.go`
- **Dec 5, 2025:** Set up complete Preact frontend with Vite build system in `web/` directory
  - Created components: App, LogViewer, ControlBar, DropZone, ResizablePanes
  - Implemented WebSocket hook with auto-reconnect
  - Added virtual scrolling with react-window
  - Configured Vite with proxy to Go backend (127.0.0.1 for IPv4)
- **Dec 5, 2025:** Implemented tabbed interface for multiple log files
  - Chrome-like tabs with add/close functionality
  - Each tab is independent with its own state
  - Tab titles automatically update to filename
  - Refined tab UI (40% smaller, softer corners)
- **Dec 5, 2025:** Backend WebSocket implementation
  - Fixed message types (initial/lines) to match frontend
  - Increased buffer size to 10MB for long log lines
  - File watcher successfully reading and streaming logs
  - Fixed message batching issue (separate WebSocket frames)
- **Dec 5, 2025:** UI improvements
  - Added resizable panes with draggable divider
  - Implemented horizontal scrolling for long log lines
  - Fixed areas to maintain size when loading files (overflow:hidden, flexShrink:0)
  - Used ResizeObserver for proper container sizing
- **Dec 5, 2025:** Settings system implementation
  - Created `/internal/settings/settings.go` with persistent storage
  - Added `/api/settings` REST endpoint (GET/POST)
  - Built SettingsModal component with configurable window size
  - Settings persist to `~/.weblogview/settings.json`
  - Frontend now omits `tail` parameter to use backend settings value
- **Dec 5, 2025:** ANSI color rendering implementation
  - Installed `ansi-to-html` npm package
  - Added ANSI rendering settings (per pane) to backend and frontend
  - LogViewer component now renders ANSI escape codes as HTML colors
  - Configurable via settings modal (both panes default to prettified)
  - Terminal colors now display properly in log viewer
- **Dec 5, 2025:** Click-to-highlight navigation feature
  - Click line number in filtered pane to highlight and jump to line in all lines pane
  - Auto-scroll automatically disables when clicking a line
  - Highlighted line shows with background color and blue line number
  - Maintains mapping between filtered and original line indices
- **Dec 5, 2025:** Production build system
  - Created `scripts/build-release.sh` for multi-platform builds
  - Created `scripts/test-build.sh` for quick local testing
  - Configured Go embed to include frontend in binary
  - Vite builds to `internal/server/static/` which is embedded
  - Added `make release` command to Makefile
  - Updated README with build instructions
  - Supports all platforms: Linux (amd64/arm64), macOS (amd64/arm64), Windows (amd64)
  - Single executable with no external dependencies
- **Dec 5, 2025:** Code cleanup
  - Removed console.log statements from LogViewerTab component
  - Cleaner console output (only errors and warnings remain)

## Current Status
- ✅ Go backend server running on localhost:8080
- ✅ Vite dev server running on localhost:3000 with proxy to backend (development)
- ✅ Production build system with embedded frontend (single executable)
- ✅ WebSocket connection established and stable
- ✅ Log files loading and displaying with configurable tail lines
- ✅ Virtual scrolling working with react-window
- ✅ Tabbed interface with add/close/switch functionality
- ✅ Dual-pane layout (all lines + filtered lines)
- ✅ Resizable panes with draggable divider
- ✅ Horizontal scrolling for long lines
- ✅ Include/exclude regex filters (supports OR/AND logic)
- ✅ Auto-scroll toggle
- ✅ Click-to-highlight line navigation between panes
- ✅ Settings system with persistent storage
- ✅ Real-time file watching (new lines streaming via WebSocket)
- ✅ ANSI color rendering (terminal colors displayed properly)
- ✅ Multi-platform release builds (Linux/macOS/Windows)

## Next Steps / TODOs
- Add file browser/selector for easier file selection
- Add syntax highlighting for log files (optional)
- Test on Windows and Linux
- Handle log file rotation
- Add "clear" button to reset log view
- Persist tab state (remember open files)
- Add more settings (theme, font size, etc.)
- Create GitHub releases with pre-built binaries

## Development Commands
```bash
# Install dependencies
go mod download
cd web && npm install && cd ..

# Run in development (with hot reload)
# Terminal 1: Backend
go run ./cmd -no-browser

# Terminal 2: Frontend dev server
cd web && npm run dev

# Production build (all platforms)
make release

# Quick test build (current platform only)
./scripts/test-build.sh

# Build single platform
go build -o weblogview ./cmd

# Run with options
./weblogview -port 8080 -host localhost -no-browser
```

## Release Build Output
Production builds create standalone executables in `dist/`:
- `weblogview-linux-amd64`
- `weblogview-linux-arm64`
- `weblogview-darwin-amd64` (macOS Intel)
- `weblogview-darwin-arm64` (macOS Apple Silicon)
- `weblogview-windows-amd64.exe`

Each executable includes the embedded frontend - no external dependencies required.

## Notes
- Project uses Go embed directive to include frontend in binary
- Frontend is built by Vite to `internal/server/static/`
- Development mode: Frontend on :3000, Backend on :8080
- Production mode: Single executable serves everything on :8080
- Settings file location: `~/.weblogview/settings.json` (all platforms)
- Currently tested on macOS, pending Windows/Linux testing
